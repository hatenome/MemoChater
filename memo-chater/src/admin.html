<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoChater - è®°å¿†ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        h1 { color: #7c3aed; font-size: 1.8em; }
        .stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #888;
        }
        .stats span { color: #7c3aed; font-weight: bold; }
        
        /* æœç´¢åŒº */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-bar input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #16213e;
            color: #eee;
            font-size: 1em;
        }
        .search-bar input:focus { outline: none; border-color: #7c3aed; }
        .search-bar select {
            padding: 12px 16px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #16213e;
            color: #eee;
            cursor: pointer;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #333; color: #eee; }
        .btn-secondary:hover { background: #444; }
        
        /* è®°å¿†åˆ—è¡¨ */
        .memory-list { display: flex; flex-direction: column; gap: 12px; }
        .memory-card {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        .memory-card:hover { border-color: #7c3aed; }
        .memory-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .memory-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .category {
            background: #7c3aed33;
            color: #a78bfa;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .importance {
            font-size: 0.8em;
            color: #888;
        }
        .importance.high { color: #f59e0b; }
        .importance.medium { color: #10b981; }
        .importance.low { color: #6b7280; }
        .score {
            font-size: 0.75em;
            color: #666;
            background: #333;
            padding: 2px 8px;
            border-radius: 8px;
        }
        .memory-content {
            color: #ddd;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .memory-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: #666;
        }
        .tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag {
            background: #333;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.85em;
        }
        .actions { display: flex; gap: 8px; }
        .actions button {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 6px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 1.3em; }
        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
        }
        .close-btn:hover { color: #eee; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #aaa;
            font-size: 0.9em;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #16213e;
            color: #eee;
            font-size: 1em;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group input:focus,
        .form-group textarea:focus { outline: none; border-color: #7c3aed; }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.5; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 40px; color: #888; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #dc2626; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§  MemoChater è®°å¿†ç®¡ç†</h1>
            <div class="stats">
                <div>è®°å¿†æ€»æ•°: <span id="totalCount">-</span></div>
                <div style="margin-left: 20px; padding-left: 20px; border-left: 1px solid #444;">
                    å¾…å¤„ç†: <span id="pendingCount" style="color: #f59e0b;">-</span>
                    <button class="btn btn-secondary" style="padding: 4px 12px; margin-left: 8px; font-size: 0.85em;" onclick="openPendingModal()">ğŸ“‹ ç®¡ç†</button>
                </div>
            </div>
        </header>
        
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="æœç´¢è®°å¿†å†…å®¹ï¼ˆè¯­ä¹‰æœç´¢ï¼‰...">
            <select id="categoryFilter">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                <option value="fact">äº‹å®</option>
                <option value="preference">åå¥½</option>
                <option value="event">äº‹ä»¶</option>
                <option value="knowledge">çŸ¥è¯†</option>
                <option value="extracted">æå–</option>
            </select>
            <button class="btn btn-secondary" onclick="loadMemories()">æœç´¢</button>
            <button class="btn btn-primary" onclick="openCreateModal()">+ æ–°å»ºè®°å¿†</button>
            <button class="btn btn-primary" style="background:#10b981" onclick="openExtractModal()">ğŸ”„ è®°å¿†è½¬åŒ–</button>
        </div>
        
        <div id="memoryList" class="memory-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- å¾…å¤„ç†æ± ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="pendingModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>ğŸ“‹ å¾…å¤„ç†æ± ç®¡ç†</h2>
                <button class="close-btn" onclick="closePendingModal()">&times;</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: #16213e; border-radius: 8px;">
                <div>
                    <span style="color: #888;">å¾…å¤„ç†è®°å¿†æ•°é‡:</span>
                    <span id="pendingModalCount" style="font-size: 1.5em; color: #f59e0b; margin-left: 8px;">-</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="background: #10b981;" onclick="processAllPending()">âœ… å…¨éƒ¨å¤„ç†</button>
                    <button class="btn btn-danger" onclick="clearAllPending()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
                    <button class="btn btn-secondary" onclick="refreshPendingStatus()">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            
            <div style="margin-bottom: 12px; color: #888; font-size: 0.9em;">
                é¢„è§ˆï¼ˆæœ€å¤šæ˜¾ç¤º10æ¡ï¼‰:
            </div>
            
            <div id="pendingPreviewList" style="max-height: 400px; overflow-y: auto;">
                <div style="color: #666; text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è®°å¿†è½¬åŒ–æ¨¡æ€æ¡† -->
    <div id="extractModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ğŸ”„ è®°å¿†è½¬åŒ–</h2>
                <button class="close-btn" onclick="closeExtractModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>å¯¹è¯å†å² (JSONæ ¼å¼)</label>
                <textarea id="extractMessages" style="min-height: 200px; font-family: monospace; font-size: 0.9em;" placeholder='[
  {"role": "user", "content": "ä½ å¥½ï¼Œæˆ‘å«ç§¦"},
  {"role": "assistant", "content": "ä½ å¥½ç§¦ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"},
  {"role": "user", "content": "æˆ‘æ˜¯ä¸€åRustç¨‹åºå‘˜"}
]'></textarea>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="autoStore" style="width: auto;">
                    è‡ªåŠ¨å­˜å‚¨æå–çš„è®°å¿†
                </label>
            </div>
            <div class="form-actions" style="justify-content: space-between;">
                <button type="button" class="btn btn-secondary" onclick="closeExtractModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" style="background:#10b981" onclick="triggerExtraction()">å¼€å§‹è½¬åŒ–</button>
            </div>
            
            <!-- è½¬åŒ–ç»“æœåŒºåŸŸ -->
            <div id="extractResult" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                <h3 style="margin-bottom: 12px; color: #10b981;">ğŸ“ è½¬åŒ–ç»“æœ</h3>
                <div id="extractedList" style="background: #16213e; border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto;"></div>
                <div id="extractRaw" style="margin-top: 12px;">
                    <details>
                        <summary style="cursor: pointer; color: #888; font-size: 0.9em;">æŸ¥çœ‹åŸå§‹å“åº”</summary>
                        <pre id="rawResponse" style="background: #0d1117; padding: 12px; border-radius: 8px; font-size: 0.8em; overflow-x: auto; margin-top: 8px;"></pre>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å»ºè®°å¿†</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="memoryForm" onsubmit="saveMemory(event)">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>å†…å®¹ *</label>
                    <textarea id="content" required placeholder="è¾“å…¥è®°å¿†å†…å®¹..."></textarea>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±» *</label>
                    <select id="category" required>
                        <option value="fact">äº‹å® (fact)</option>
                        <option value="preference">åå¥½ (preference)</option>
                        <option value="event">äº‹ä»¶ (event)</option>
                        <option value="knowledge">çŸ¥è¯† (knowledge)</option>
                        <option value="other">å…¶ä»– (other)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡è¦æ€§ (0.0 - 1.0)</label>
                    <input type="number" id="importance" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="form-group">
                    <label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                    <input type="text" id="tags" placeholder="æ ‡ç­¾1, æ ‡ç­¾2, ...">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api';
        
        // åŠ è½½è®°å¿†åˆ—è¡¨
        async function loadMemories() {
            const query = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            
            const params = new URLSearchParams();
            if (query) params.set('query', query);
            if (category) params.set('category', category);
            params.set('limit', '100');
            
            const listEl = document.getElementById('memoryList');
            listEl.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/memories?${params}`);
                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }
                
                const { memories, total } = data.data;
                document.getElementById('totalCount').textContent = total;
                
                if (memories.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            <p>æš‚æ— è®°å¿†</p>
                            <p style="margin-top:10px;font-size:0.9em">ç‚¹å‡»"æ–°å»ºè®°å¿†"æ·»åŠ ç¬¬ä¸€æ¡è®°å¿†</p>
                        </div>
                    `;
                    return;
                }
                
                listEl.innerHTML = memories.map(item => renderMemoryCard(item)).join('');
            } catch (e) {
                listEl.innerHTML = `<div class="empty-state"><p>åŠ è½½å¤±è´¥: ${e.message}</p></div>`;
                showToast(e.message, 'error');
            }
        }
        
        // æ¸²æŸ“è®°å¿†å¡ç‰‡
        function renderMemoryCard({ memory, score }) {
            const m = memory;
            const impClass = m.importance >= 0.7 ? 'high' : m.importance >= 0.4 ? 'medium' : 'low';
            const impText = m.importance >= 0.7 ? 'é«˜' : m.importance >= 0.4 ? 'ä¸­' : 'ä½';
            const tagsHtml = m.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
            const scoreHtml = score ? `<span class="score">ç›¸å…³åº¦: ${(score * 100).toFixed(1)}%</span>` : '';
            
            return `
                <div class="memory-card" data-id="${m.id}">
                    <div class="memory-header">
                        <div class="memory-meta">
                            <span class="category">${escapeHtml(m.category)}</span>
                            <span class="importance ${impClass}">é‡è¦æ€§: ${impText} (${m.importance})</span>
                            ${scoreHtml}
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="viewMemory('${m.id}')">æŸ¥çœ‹</button>
                            <button class="btn btn-danger" onclick="deleteMemory('${m.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="memory-content">${escapeHtml(m.content)}</div>
                    <div class="memory-footer">
                        <div class="tags">${tagsHtml}</div>
                        <div>è®¿é—® ${m.access_count} æ¬¡ Â· ${formatDate(m.created_at)}</div>
                    </div>
                </div>
            `;
        }
        
        // æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å»ºè®°å¿†';
            document.getElementById('editId').value = '';
            document.getElementById('memoryForm').reset();
            document.getElementById('importance').value = '0.5';
            document.getElementById('createModal').classList.add('active');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('createModal').classList.remove('active');
        }
        
        // ä¿å­˜è®°å¿†
        async function saveMemory(e) {
            e.preventDefault();
            
            const content = document.getElementById('content').value.trim();
            const category = document.getElementById('category').value;
            const importance = parseFloat(document.getElementById('importance').value) || 0.5;
            const tagsStr = document.getElementById('tags').value.trim();
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
            
            try {
                const res = await fetch(`${API_BASE}/memories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, category, importance, tags })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                showToast('è®°å¿†åˆ›å»ºæˆåŠŸ', 'success');
                closeModal();
                loadMemories();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // æŸ¥çœ‹è®°å¿†è¯¦æƒ…
        async function viewMemory(id) {
            try {
                const res = await fetch(`${API_BASE}/memories/${id}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const m = data.data;
                alert(`ID: ${m.id}\n\nå†…å®¹:\n${m.content}\n\nåˆ†ç±»: ${m.category}\né‡è¦æ€§: ${m.importance}\næ ‡ç­¾: ${m.tags.join(', ')}\nè®¿é—®æ¬¡æ•°: ${m.access_count}\nåˆ›å»ºæ—¶é—´: ${m.created_at}`);
            } catch (e) {
                showToast('è·å–è¯¦æƒ…å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // åˆ é™¤è®°å¿†
        async function deleteMemory(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            
            try {
                const res = await fetch(`${API_BASE}/memories/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadMemories();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function formatDate(isoStr) {
            const d = new Date(isoStr);
            return d.toLocaleDateString('zh-CN') + ' ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') loadMemories();
        });
        
        // ========== å¾…å¤„ç†æ± ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½å¾…å¤„ç†æ± çŠ¶æ€
        async function loadPendingStatus() {
            try {
                const res = await fetch(`${API_BASE}/pending`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('pendingCount').textContent = data.data.pending_count;
                    return data.data;
                }
            } catch (e) {
                console.error('åŠ è½½å¾…å¤„ç†æ± çŠ¶æ€å¤±è´¥:', e);
            }
            return null;
        }
        
        // æ‰“å¼€å¾…å¤„ç†æ± æ¨¡æ€æ¡†
        async function openPendingModal() {
            document.getElementById('pendingModal').classList.add('active');
            await refreshPendingStatus();
        }
        
        // å…³é—­å¾…å¤„ç†æ± æ¨¡æ€æ¡†
        function closePendingModal() {
            document.getElementById('pendingModal').classList.remove('active');
        }
        
        // åˆ·æ–°å¾…å¤„ç†æ± çŠ¶æ€
        async function refreshPendingStatus() {
            const listEl = document.getElementById('pendingPreviewList');
            listEl.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/pending`);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                const { pending_count, preview } = data.data;
                document.getElementById('pendingModalCount').textContent = pending_count;
                document.getElementById('pendingCount').textContent = pending_count;
                
                if (preview.length === 0) {
                    listEl.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">å¾…å¤„ç†æ± ä¸ºç©º</div>';
                    return;
                }
                
                listEl.innerHTML = preview.map((m, i) => `
                    <div style="padding: 12px; background: #1a1a2e; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #f59e0b;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="color: #888; font-size: 0.8em;">#${i + 1} Â· ${escapeHtml(m.category)}</span>
                            <span style="color: #666; font-size: 0.8em;">é‡è¦æ€§: ${m.importance}</span>
                        </div>
                        <div style="color: #ddd; line-height: 1.5;">${escapeHtml(m.content)}</div>
                        <div style="color: #555; font-size: 0.75em; margin-top: 6px;">
                            æ¥æº: ${escapeHtml(m.source_session)} Â· ${formatDate(m.created_at)}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                listEl.innerHTML = `<div style="color: #dc2626; text-align: center; padding: 40px;">åŠ è½½å¤±è´¥: ${escapeHtml(e.message)}</div>`;
            }
        }
        
        // å¤„ç†å…¨éƒ¨å¾…å¤„ç†è®°å¿†
        async function processAllPending() {
            if (!confirm('ç¡®å®šè¦å°†æ‰€æœ‰å¾…å¤„ç†è®°å¿†å­˜å…¥é•¿æœŸè®°å¿†åº“å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/pending/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const { processed, failed, remaining } = data.data;
                showToast(`æˆåŠŸå¤„ç† ${processed} æ¡ï¼Œå¤±è´¥ ${failed} æ¡ï¼Œå‰©ä½™ ${remaining} æ¡`, 'success');
                
                await refreshPendingStatus();
                loadMemories(); // åˆ·æ–°è®°å¿†åˆ—è¡¨
            } catch (e) {
                showToast('å¤„ç†å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // æ¸…ç©ºå…¨éƒ¨å¾…å¤„ç†è®°å¿†
        async function clearAllPending() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            
            try {
                const res = await fetch(`${API_BASE}/pending`, { method: 'DELETE' });
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                showToast(data.data, 'success');
                await refreshPendingStatus();
            } catch (e) {
                showToast('æ¸…ç©ºå¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // ========== è®°å¿†è½¬åŒ–åŠŸèƒ½ ==========
        
        // æ‰“å¼€è½¬åŒ–æ¨¡æ€æ¡†
        function openExtractModal() {
            document.getElementById('extractModal').classList.add('active');
            document.getElementById('extractResult').style.display = 'none';
            document.getElementById('extractMessages').value = '';
            document.getElementById('autoStore').checked = false;
        }
        
        // å…³é—­è½¬åŒ–æ¨¡æ€æ¡†
        function closeExtractModal() {
            document.getElementById('extractModal').classList.remove('active');
        }
        
        // è§¦å‘è®°å¿†è½¬åŒ–
        async function triggerExtraction() {
            const messagesStr = document.getElementById('extractMessages').value.trim();
            const autoStore = document.getElementById('autoStore').checked;
            
            if (!messagesStr) {
                showToast('è¯·è¾“å…¥å¯¹è¯å†å²', 'error');
                return;
            }
            
            let messages;
            try {
                messages = JSON.parse(messagesStr);
                if (!Array.isArray(messages)) throw new Error('å¿…é¡»æ˜¯æ•°ç»„');
            } catch (e) {
                showToast('JSONæ ¼å¼é”™è¯¯: ' + e.message, 'error');
                return;
            }
            
            const resultDiv = document.getElementById('extractResult');
            const listDiv = document.getElementById('extractedList');
            const rawPre = document.getElementById('rawResponse');
            
            listDiv.innerHTML = '<div style="color: #888;">è½¬åŒ–ä¸­ï¼Œè¯·ç¨å€™...</div>';
            resultDiv.style.display = 'block';
            
            try {
                const res = await fetch(`${API_BASE}/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages, auto_store: autoStore })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'è½¬åŒ–å¤±è´¥');
                
                const result = data.data;
                rawPre.textContent = result.raw_response || '(æ— )';
                
                if (result.extracted_memories.length === 0) {
                    listDiv.innerHTML = '<div style="color: #888;">æœªæå–åˆ°ä»»ä½•è®°å¿†</div>';
                } else {
                    const items = result.extracted_memories.map((m, i) => `
                        <div style="padding: 8px 12px; background: #1a1a2e; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #10b981;">
                            <span style="color: #666; font-size: 0.8em;">#${i + 1}</span>
                            <div style="margin-top: 4px;">${escapeHtml(m)}</div>
                        </div>
                    `).join('');
                    
                    let summary = `<div style="margin-bottom: 12px; color: #10b981;">âœ… æˆåŠŸæå– ${result.extracted_memories.length} æ¡è®°å¿†</div>`;
                    if (result.stored_count !== null) {
                        summary += `<div style="margin-bottom: 12px; color: #f59e0b;">ğŸ’¾ å·²å­˜å‚¨ ${result.stored_count} æ¡åˆ°é•¿æœŸè®°å¿†</div>`;
                    }
                    
                    listDiv.innerHTML = summary + items;
                    
                    if (result.stored_count > 0) {
                        showToast(`å·²å­˜å‚¨ ${result.stored_count} æ¡è®°å¿†`, 'success');
                        loadMemories(); // åˆ·æ–°åˆ—è¡¨
                    }
                }
            } catch (e) {
                listDiv.innerHTML = `<div style="color: #dc2626;">âŒ è½¬åŒ–å¤±è´¥: ${escapeHtml(e.message)}</div>`;
                showToast('è½¬åŒ–å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // åˆå§‹åŠ è½½
        loadMemories();
        loadPendingStatus();
    </script>
</body>
</html>