# MemoChater WebUI - 组件说明

## 一、布局组件

### 1.1 Sidebar.vue ⭐ 重构

侧边栏导航组件，包含：
- Logo 和折叠按钮
- 助手列表
- **话题列表分组显示** ⭐
  - 普通话题区域（默认主题）
  - 记忆话题区域（绿色主题）
- 底部导航（助手管理、记忆管理、设置）

**Props:** 无

**Events:** 无

**状态依赖:**
- `useAppStore().sidebarCollapsed` - 折叠状态
- `useAssistantStore()` - 助手/话题数据

**计算属性:**
```typescript
// 分离普通话题和记忆话题
const normalTopics = computed(() => 
  store.topics.filter(t => t.topic_type === 'normal' || !t.topic_type)
)
const memoryTopics = computed(() => 
  store.topics.filter(t => t.topic_type === 'memory')
)
```

**关键功能:**
```typescript
// 选择助手
function selectAssistant(id: string) {
  router.push(`/chat/${id}`)
}

// 选择话题（单击）
function selectTopic(topicId: string) {
  router.push(`/chat/${assistantId}/${topicId}`)
}

// 创建话题（点击+按钮，自动使用时间标题）⭐ 2026-01-05 更新
async function createTopic(topicType: TopicType) {
  const title = generateTimeTitle()  // 格式：MM-DD HH:mm
  const topicId = await store.createTopic(title, topicType)
  router.push(`/chat/${assistantId}/${topicId}`)
}

// 双击话题进入编辑模式 ⭐ 2026-01-05 新增
function startEditTopic(topic: { id: string; title: string }) {
  editingTopicId.value = topic.id
  editingTopicTitle.value = topic.title
}

// 保存话题标题
async function saveTopicTitle() {
  await store.updateTopicTitle(editingTopicId.value, editingTopicTitle.value)
}

// 删除话题
async function deleteTopic(topicId: string) {
  await store.deleteTopic(topicId)
}
```

### 1.2 Toast.vue

消息提示组件，使用 Teleport 渲染到 body。

**状态依赖:**
- `useAppStore().toasts` - 消息队列

**样式类型:**
- `success` - 绿色背景
- `error` - 红色背景
- `info` - 蓝色背景

---

## 二、对话组件

### 2.1 ChatInput.vue

聊天输入框组件。

**Props:**
| 属性 | 类型 | 说明 |
|------|------|------|
| `disabled` | boolean | 禁用状态 |
| `loading` | boolean | 加载状态 |

**Events:**
| 事件 | 参数 | 说明 |
|------|------|------|
| `send` | message: string | 发送消息 |

**快捷键:**
- `Enter` - 发送消息
- `Shift+Enter` - 换行

### 2.2 ChatMessage.vue

消息气泡组件，支持消息操作。

**Props:**
| 属性 | 类型 | 说明 |
|------|------|------|
| `message` | ChatMessage | 消息对象 |
| `index` | number | 消息索引 |
| `assistantName` | string | 助手名称 |
| `userName` | string | 用户名称 |

**Events:**
| 事件 | 参数 | 说明 |
|------|------|------|
| `edit` | index: number, content: string | 编辑消息 |
| `delete` | index: number | 删除消息 |
| `branch` | index: number | 创建分支 |
| `regenerate` | index: number | 重新生成（仅助手消息）⭐ |

**功能特性:**
- 悬停显示操作按钮（编辑、分支、重新生成、删除）
- 编辑模式：显示文本框，Ctrl+Enter 保存，Esc 取消
- 删除前确认提示
- 显示消息索引号 `#0`, `#1`...

**样式区分:**
- 用户消息：蓝色头像，深色背景
- 助手消息：紫色头像，浅色背景

---

## 三、页面视图

### 3.1 ChatView.vue ⭐ 重构

对话主页面，支持话题类型区分。

**路由参数:**
- `assistantId` - 助手ID（可选）
- `topicId` - 话题ID（可选）

**话题类型判断:**
```typescript
// 判断当前话题是否为记忆话题
const isMemoryTopic = computed(() => store.currentTopic?.topic_type === 'memory')
```

**布局变化:**
- 普通话题：对话区域占满宽度，无右侧记忆面板
- 记忆话题：显示右侧记忆面板（思考池 + 短期记忆）
- 记忆话题：消息列表下方显示"上一轮对话"框 ⭐ 新增

**新增状态 (2026-01-04):**
```typescript
const conversationTurns = ref<ConversationTurn[]>([])  // 历史对话轮次
```

**核心逻辑:**
```typescript
// 发送消息（流式）
async function sendMessage(content: string) {
  // 1. 添加用户消息
  store.addMessage({ role: 'user', content })
  
  // 2. 添加空的助手消息
  store.addMessage({ role: 'assistant', content: '' })
  
  // 3. 流式接收响应
  const stream = chatApi.stream({ model, messages, assistant_id, topic_id })
  for await (const chunk of stream) {
    streamingContent += chunk
    store.updateLastMessage(streamingContent)
  }
}

// 编辑消息
async function handleEditMessage(index: number, content: string) {
  await store.editMessage(index, content)
}

// 删除消息
async function handleDeleteMessage(index: number) {
  await store.removeMessage(index)
}

// 创建分支
async function handleBranchFromMessage(index: number) {
  const title = prompt('请输入分支话题标题')
  await store.createBranchFromMessage(index, title)
}
```

**状态:**
- `isStreaming` - 是否正在流式接收
- `streamingContent` - 流式内容缓冲

**后处理完成通知：** ⭐ 新增
- 流式响应结束后，后端发送 `[POST_PROCESS_DONE]` 事件
- 前端收到后调用 `loadPacketMemory()` 刷新数据
- 记忆话题会同时更新 `store.messages`

### 3.2 AssistantsView.vue

助手管理页面，含完整配置编辑。

**功能:**
- 助手列表展示
- 创建助手（模态框）
- 编辑助手（模态框）
- 删除助手（确认对话框）
- **动态模型列表**（从API获取）

**表单字段:**
- 基本信息：名称、描述、系统提示词
- 模型配置：⭐
  - 主模型（对话）- 用于生成对话回复
  - 处理模型（记忆处理）- 2号AI分析对话
  - 提取模型（信息提取）- 从历史提取记忆
  - Embedding 模型（向量化）- 记忆存储和检索
  - 温度、最大输出Token
- 角色配置：用户名称、助手名称
- 记忆配置：启用开关、检索数量、相关性阈值

**流水线配置模态框：** ⭐
- 6个处理时机的可视化配置
  - 用户发言后 (`on_user_message`)
  - AI调用前 (`before_ai_call`)
  - 流式开始 (`on_stream_start`)
  - 流式块 (`on_stream_chunk`)
  - AI响应后 (`after_ai_response`) - 同步，阻塞下一次对话
  - **后台处理 (`background_process`)** - 异步，不阻塞下一次对话 ⭐
- 每个处理器条目包含：名称下拉框 + 描述输入框
- 支持添加/删除/上移/下移处理器

**动态模型加载:**
```typescript
async function loadModels() {
  const models = await modelsApi.list()
  // 分类：embedding 模型和普通模型
  embeddingModelOptions.value = models.filter(m => m.id.includes('embedding'))
  modelOptions.value = models.filter(m => !m.id.includes('embedding'))
}
```

### 3.3 MemoryView.vue

记忆管理页面（按助手隔离）⭐ 重构。

**路由参数:**
- `assistantId` - 助手ID（必需）

**功能:**
- **按助手隔离** - 每个助手有独立的记忆存储
- 无搜索词时列出所有记忆（使用 scroll API）
- 语义搜索记忆（需要 embedding）
- 分类过滤
- 创建新记忆
- 删除记忆
- 待处理池管理（模态框）
- 返回按钮（返回对话页面）

**搜索参数:**
- `query` - 搜索关键词（可选，无则列出全部）
- `category` - 分类过滤
- `limit` - 返回数量

### 3.4 SettingsView.vue

设置页面。

**配置项:**
- API 地址
- 主题（暂只支持深色）

---

## 四、类型定义

### 4.0 话题类型 ⭐ 新增

```typescript
// 话题类型
type TopicType = 'normal' | 'memory'

interface TopicMeta {
  id: string
  title: string
  topic_type: TopicType  // 话题类型
  created_at: string
  updated_at: string
  message_count?: number
}

interface TopicSummary {
  id: string
  assistant_id: string
  title: string
  topic_type: TopicType  // 话题类型
  message_count: number
  created_at: string
  updated_at: string
}
```

### 4.1 助手相关

```typescript
interface AssistantConfig {
  name: string
  description: string
  system_prompt: string
  model: ModelConfig
  roles: RolesConfig
  memory: MemoryConfig
  created_at: string
  updated_at: string
}

interface ModelConfig {
  main_model: string       // 主对话模型
  processor_model: string  // 记忆处理模型
  embedding_model: string  // 向量化模型 ⭐
  extractor_model: string  // 信息提取模型
  temperature: number
  max_tokens: number
}

interface MemoryConfig {
  enabled: boolean
  retrieval_count: number
  relevance_threshold: number
}
```

### 4.2 消息相关

```typescript
interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
}
```

### 4.3 记忆相关

```typescript
// 长期记忆
interface Memory {
  id: string
  content: string
  category: string
  importance: number
  tags: string[]
  access_count: number
  created_at: string
}

interface MemorySearchResult {
  memory: Memory
  score: number
}

// 短期记忆 ⭐ 结构化重构
interface ShortTermMemoryEntry {
  id: string
  summary: string      // 概述/标题
  content: string      // 详细内容
  memory_type: string  // 类型（fact/event/preference/knowledge/task/other）
  relevance: number
  source: string
  timestamp: string
}
```

### 4.4 模型相关

```typescript
interface ModelInfo {
  id: string
  object?: string
  owned_by?: string
}
```

---

## 五、样式规范

### 颜色主题

```javascript
// tailwind.config.js
colors: {
  primary: {
    400: '#a78bfa',  // 文字
    500: '#8b5cf6',  // 按钮
    600: '#7c3aed',  // 按钮hover
  },
  dark: {
    700: '#334155',  // 边框
    800: '#1e293b',  // 卡片背景
    900: '#0f172a',  // 侧边栏
    950: '#020617',  // 页面背景
  }
}
```

### 常用类名

| 用途 | 类名 |
|------|------|
| 页面背景 | `bg-dark-950` |
| 卡片背景 | `bg-dark-800` |
| 边框 | `border-dark-700` |
| 主按钮 | `bg-primary-600 hover:bg-primary-700` |
| 次按钮 | `bg-dark-700 hover:bg-dark-600` |
| 危险按钮 | `bg-red-600 hover:bg-red-700` |
| 输入框 | `bg-dark-800 border-dark-600 focus:border-primary-500` |